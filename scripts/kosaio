#!/bin/bash

# KOSAIO - The Dreamcast SDK Master Orchestrator (Refactored Overlord 5D)
# This script is the main entry point (Capa de OrquestaciÃ³n).
# It delegates logic to specialized engines in scripts/engine/

set -Eeuo pipefail

if [ -z "${KOSAIO_DIR}" ]; then
	SOURCE="${BASH_SOURCE[0]}"
	while [ -h "$SOURCE" ]; do
	  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
	  SOURCE="$(readlink "$SOURCE")"
	  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
	done
	DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
	export KOSAIO_DIR="$(dirname "$DIR")"
fi
ENGINE_DIR="${KOSAIO_DIR}/scripts/engine"

# Load essential UI and Environment
source "${KOSAIO_DIR}/scripts/common/env.sh"

# Self-Heal Environment Configuration
ensure_bashrc_config

source "${KOSAIO_DIR}/scripts/common/ui.sh"
source "${KOSAIO_DIR}/scripts/common/deps.sh"
source "${KOSAIO_DIR}/scripts/common/errors.sh"



# Load common utilities
source "${KOSAIO_DIR}/scripts/common/git_utils.sh"
source "${KOSAIO_DIR}/scripts/common/port_utils.sh"

function show_usage() {
	# Version Extraction
	local K_BRANCH="unknown"
	local K_COMMIT="unknown"
	local K_DATE="unknown"
	if [ -d "${KOSAIO_DIR}/.git" ]; then
		K_BRANCH=$(git -C "${KOSAIO_DIR}" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "detached")
		K_COMMIT=$(git -C "${KOSAIO_DIR}" rev-parse --short HEAD 2>/dev/null || echo "unknown")
		K_DATE=$(git -C "${KOSAIO_DIR}" show -s --format=%cd --date=short HEAD 2>/dev/null || echo "unknown")
	fi

	echo -e "${C_B_CYAN}KOSAIO - THE DREAMCAST SDK Master Orchestrator${C_RESET}"
	echo -e "${C_B_CYAN}Version:${C_RESET} ${C_B_MAGENTA}${K_BRANCH}${C_RESET} ${C_GRAY}@${C_RESET} ${C_MAGENTA}${K_COMMIT}${C_RESET} ${C_GRAY}(${K_DATE})${C_RESET}"
	echo -e "${C_GRAY}Refactored Overlord 5D | Engine Powered discovery${C_RESET}"
	echo ""
	
	echo -e "${C_BOLD}USAGE:${C_RESET}"
	echo -e "  ${C_BLUE}kosaio${C_RESET} ${C_CYAN}<action>${C_RESET} ${C_YELLOW}[target/query]${C_RESET} ${C_GRAY}[arguments]${C_RESET}\n"
	
	echo -e "${C_BOLD}DISCOVERY:${C_RESET}"
	local lrow="${C_CYAN}%-12s${C_RESET} ${C_YELLOW}%-15s${C_RESET}"
	printf "  ${lrow} %s\n" "list" "[query]" "Search tools/ports and see their status"
	printf "  ${lrow} %s\n" "search" "<query>" "Quick alias for 'list' discovery"
	printf "  ${lrow} %s\n" "info" "<id>" "Show detailed metadata about a tool/port"
	printf "  ${lrow} %s\n" "diagnose" "<id|self|sys>" "Health check (Tool, KOSAIO itself, or System)"
	echo ""

	echo -e "${C_BOLD}TOOL LIFECYCLE:${C_RESET}"
	local lrow_life="${C_CYAN}%-12s${C_RESET} ${C_YELLOW}%-10s${C_RESET} ${C_GRAY}%-10s${C_RESET}"
	printf "  ${lrow_life} %s\n" "install" "<id>" "[args...]" "Complete setup (Clone, Build, Apply)"
	printf "  ${lrow_life} %s\n" "update" "<id>" "[args...]" "Pull latest source and rebuild"
	printf "  ${lrow_life} %s\n" "uninstall" "<id>" "" "Remove tool/sdk from the system"
	printf "  ${lrow_life} %s\n" "clone" "<id>" "[args...]" "Download source code only"
	printf "  ${lrow_life} %s\n" "build" "<id>" "[args...]" "Run compilation on local source"
	printf "  ${lrow_life} %s\n" "apply" "<id>" "" "Register local build binaries"
	printf "  ${lrow_life} %s\n" "checkout" "<id>" "<ref>" "Switch to git branch/tag/commit"
	printf "  ${lrow_life} %s\n" "clean" "<id>" "" "Clean build artifacts"
	echo ""

	echo -e "${C_BOLD}SYSTEM WORKFLOW:${C_RESET}"
	printf "  ${lrow} %s\n" "dev-switch" "<id> [mode]" "Toggle between CONTAINER and HOST mode"
	printf "  ${lrow} %s\n" "create-proj" "<name>" "Initialize a new project folder"
	printf "  ${lrow} %s\n" "install-deps" "system" "Install core SDK dependencies (GCC, Make, etc)"
	printf "  ${lrow} %s\n" "self-update" "" "Update KOSAIO framework and scripts"
	echo ""
	exit 1
}

# --- Action Handlers ---

# Load internal drivers
source "${ENGINE_DIR}/driver_search.sh"
source "${ENGINE_DIR}/ports/__init__.sh"
source "${ENGINE_DIR}/driver_manager.sh"
source "${ENGINE_DIR}/driver_health.sh"
source "${ENGINE_DIR}/driver_validator.sh"
source "${ENGINE_DIR}/error_handler.sh"

# Load Router
source "${KOSAIO_DIR}/scripts/controllers/router.sh"

# --- Main Initialization ---

ACTION="${1:-}"
ACTION="${ACTION,,}"
TARGET="${2:-}"
TARGET="${TARGET,,}"

[ -z "$ACTION" ] && show_usage

# Dispatch to Router
kosaio_router_dispatch "$ACTION" "$TARGET" "${@:3}"
